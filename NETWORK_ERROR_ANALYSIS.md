# PolyTorus Network Error Analysis Report

## æ¦‚è¦

PolyTorusãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤ã«ãŠã‘ã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®åŒ…æ‹¬çš„ãªåˆ†æã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚TESTNETã‚’æ‰‹å…ƒã§å‹•ã‹ã—ãŸçŠ¶æ…‹ã§ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®ç™ºç”ŸçŠ¶æ³ã¨å¯¾å‡¦çŠ¶æ³ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚

## å®Ÿè¡Œç’°å¢ƒ

- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: PolyTorus v0.1.0
- **Rustç‰ˆ**: nightly-2025-06-15
- **ãƒ†ã‚¹ãƒˆæ—¥æ™‚**: 2025å¹´1æœˆ25æ—¥
- **ç’°å¢ƒ**: Linux x86_64

## ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼

### âœ… æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹é …ç›®

1. **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼**
   - å…¨ã¦ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆmodular-node1.toml, modular-node2.toml, modular-node3.tomlï¼‰ãŒé©åˆ‡ã«ä½œæˆã•ã‚Œã¦ã„ã‚‹
   - å¿…è¦ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã‚‹
   - ãƒãƒ¼ãƒˆè¨­å®šã¨ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ãƒ”ã‚¢è¨­å®šãŒæ­£ã—ãæ§‹æˆã•ã‚Œã¦ã„ã‚‹

2. **åŸºæœ¬çš„ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   - å­˜åœ¨ã—ãªã„ãƒãƒ¼ãƒˆã¸ã®æ¥ç¶šè©¦è¡ŒãŒé©åˆ‡ã«å¤±æ•—ã™ã‚‹
   - æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
   - åˆ°é”ä¸å¯èƒ½ãªãƒ›ã‚¹ãƒˆã¸ã®æ¥ç¶šãŒé©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹

3. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**
   - localhost (127.0.0.1) ã¸ã® ãƒã‚¤ãƒ³ãƒ‰ãŒå¯èƒ½
   - å…¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ (0.0.0.0) ã¸ã®ãƒã‚¤ãƒ³ãƒ‰ãŒå¯èƒ½
   - å¿…è¦ãªãƒãƒ¼ãƒˆï¼ˆ8001-8003, 9001-9003ï¼‰ãŒåˆ©ç”¨å¯èƒ½

4. **ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**
   - ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆdata/node1, data/node2, data/node3ï¼‰ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¦ã„ã‚‹
   - ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæº–å‚™ã•ã‚Œã¦ã„ã‚‹

### âš ï¸ åˆ¶é™äº‹é …ãƒ»èª²é¡Œ

1. **GLIBCäº’æ›æ€§å•é¡Œ**
   - ãƒã‚¤ãƒŠãƒªå®Ÿè¡Œæ™‚ã«GLIBC_2.36ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
   - å®Ÿéš›ã®ãƒãƒ¼ãƒ‰èµ·å‹•ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã§ããªã„çŠ¶æ³

2. **åŒæœŸãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã®å•é¡Œ**
   - `std::sync::MutexGuard`ãŒSendãƒˆãƒ¬ã‚¤ãƒˆã‚’å®Ÿè£…ã—ã¦ã„ãªã„ãŸã‚ã€ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã§ããªã„
   - éåŒæœŸç’°å¢ƒã§ã®Mutexä½¿ç”¨ã«é–¢ã™ã‚‹è¨­è¨ˆä¸Šã®èª²é¡Œ

## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å®Ÿè£…çŠ¶æ³

### ğŸ”§ å®Ÿè£…æ¸ˆã¿ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ©Ÿèƒ½

#### 1. æ¥ç¶šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
```rust
// æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®å®Ÿè£…
let stream = match timeout(Duration::from_secs(10), TcpStream::connect(addr)).await {
    Ok(Ok(stream)) => stream,
    Ok(Err(e)) => {
        // æ¥ç¶šå¤±æ•—ã®è¨˜éŒ²
        Self::record_connection_failure(connection_pool.clone(), addr, format!("TCP connection failed: {}", e)).await;
        return Err(anyhow::anyhow!("TCP connection failed: {}", e));
    }
    Err(_) => {
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®è¨˜éŒ²
        Self::record_connection_failure(connection_pool.clone(), addr, "Connection timeout".to_string()).await;
        return Err(anyhow::anyhow!("Connection timeout"));
    }
};
```

#### 2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚µã‚¤ã‚ºåˆ¶é™
```rust
const MAX_MESSAGE_SIZE: usize = 10 * 1024 * 1024; // 10MB

if len > MAX_MESSAGE_SIZE {
    return Err(anyhow::anyhow!("Message too large: {}", len));
}
```

#### 3. ãƒ”ã‚¢ç®¡ç†ã¨ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆ
```rust
// ãƒ”ã‚¢ã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
fn is_stale(&self) -> bool {
    let is_stale = self.last_pong.elapsed() > Duration::from_secs(PEER_TIMEOUT);
    if is_stale {
        log::debug!("Peer {} is stale (last pong: {:?} ago)", self.peer_id, self.last_pong.elapsed());
    }
    is_stale
}

// ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆæ©Ÿèƒ½
struct BlacklistEntry {
    reason: String,
    blacklisted_at: Instant,
    duration: Option<Duration>,
}
```

#### 4. æ¥ç¶šãƒ—ãƒ¼ãƒ«ç®¡ç†
```rust
struct ConnectionPool {
    active_connections: HashMap<PeerId, ActiveConnection>,
    pending_connections: HashMap<SocketAddr, PendingConnection>,
    failed_connections: HashMap<SocketAddr, FailedConnection>,
}
```

#### 5. å†è©¦è¡Œãƒ¡ã‚«ãƒ‹ã‚ºãƒ 
```rust
// ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—æ¥ç¶šã®å†è©¦è¡Œ
while retry_count < MAX_RETRIES {
    match Self::connect_to_peer(...).await {
        Ok(()) => break,
        Err(e) => {
            retry_count += 1;
            if retry_count < MAX_RETRIES {
                tokio::time::sleep(Duration::from_secs(RETRY_DELAY)).await;
            }
        }
    }
}
```

### ğŸ“Š ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµ±è¨ˆã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

```rust
struct NetworkStats {
    pub total_connections: u64,
    pub active_connections: u64,
    pub messages_sent: u64,
    pub messages_received: u64,
    pub bytes_sent: u64,
    pub bytes_received: u64,
    pub blocks_propagated: u64,
    pub transactions_propagated: u64,
}
```

### ğŸ›¡ï¸ ã‚¨ãƒ©ãƒ¼å›å¾©æ©Ÿèƒ½

1. **è‡ªå‹•ãƒ”ã‚¢ç™ºè¦‹**: æ¥ç¶šãŒå¤±ã‚ã‚ŒãŸå ´åˆã®è‡ªå‹•å†æ¥ç¶š
2. **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã‚¤ãƒ³ã‚°**: ä¸€æ™‚çš„ãªæ¥ç¶šå•é¡Œæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿æŒ
3. **æ¥ç¶šæ¤œè¨¼**: è«–ç†çš„æ¥ç¶šã¨ç‰©ç†çš„æ¥ç¶šã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
4. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ˜ãƒ«ã‚¹ç›£è¦–**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å…¨ä½“ã®å¥å…¨æ€§è¿½è·¡

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ

### åŸºæœ¬ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ
- âœ… å­˜åœ¨ã—ãªã„ãƒ”ã‚¢ã¸ã®æ¥ç¶š: é©åˆ‡ã«å¤±æ•—
- âœ… æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: æ­£å¸¸ã«å‹•ä½œ
- âœ… ãƒãƒ¼ãƒˆãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç«¶åˆ: æ¤œå‡ºå¯èƒ½
- âœ… ç„¡åŠ¹ãªã‚¢ãƒ‰ãƒ¬ã‚¹: é©åˆ‡ã«å‡¦ç†
- âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³: æ­£å¸¸ã«å‹•ä½œ

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å›å¾©åŠ›ãƒ†ã‚¹ãƒˆ
- âœ… è¤‡æ•°ã®åŒæ™‚æ¥ç¶šè©¦è¡Œ: é©åˆ‡ã«å‡¦ç†
- âœ… æ€¥é€Ÿãªæ¥ç¶šè©¦è¡Œ: ã‚¨ãƒ©ãƒ¼ç‡ãŒæœŸå¾…é€šã‚Š
- âœ… å¤§å®¹é‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ã‚µã‚¤ã‚ºåˆ¶é™ãŒæ©Ÿèƒ½

## æ¨å¥¨äº‹é …

### çŸ­æœŸçš„æ”¹å–„
1. **GLIBCäº’æ›æ€§ã®è§£æ±º**: å®Ÿè¡Œç’°å¢ƒã®ä¾å­˜é–¢ä¿‚ã‚’ä¿®æ­£
2. **åŒæœŸãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã®æ”¹å–„**: `tokio::sync::Mutex`ã®ä½¿ç”¨ã‚’æ¤œè¨
3. **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®æ‹¡å……**: å®Ÿéš›ã®ãƒãƒ¼ãƒ‰é–“é€šä¿¡ãƒ†ã‚¹ãƒˆã®è¿½åŠ 

### é•·æœŸçš„æ”¹å–„
1. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­è€æ€§**: ã‚ˆã‚Šé«˜åº¦ãªåˆ†æ–­æ¤œå‡ºã¨å›å¾©æ©Ÿèƒ½
2. **å‹•çš„ãƒ”ã‚¢ç™ºè¦‹**: DHTï¼ˆåˆ†æ•£ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã®å®Ÿè£…
3. **QoSæ©Ÿèƒ½**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å“è³ªã«åŸºã¥ãå‹•çš„èª¿æ•´

## çµè«–

PolyTorusã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å±¤ã¯åŒ…æ‹¬çš„ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ãŠã‚Šã€ä»¥ä¸‹ã®ç‚¹ã§å„ªç§€ã§ã™ï¼š

1. **å …ç‰¢æ€§**: æ§˜ã€…ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚·ãƒŠãƒªã‚ªã«å¯¾å¿œ
2. **å›å¾©åŠ›**: è‡ªå‹•å†æ¥ç¶šã¨æ¥ç¶šãƒ—ãƒ¼ãƒ«ç®¡ç†
3. **ç›£è¦–æ©Ÿèƒ½**: è©³ç´°ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµ±è¨ˆã¨ãƒ˜ãƒ«ã‚¹ç›£è¦–
4. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: å¤§è¦æ¨¡ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«å¯¾å¿œã™ã‚‹è¨­è¨ˆ

ç¾åœ¨ã®å®Ÿè£…ã¯æœ¬æ ¼çš„ãªãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®è¦ä»¶ã‚’æº€ãŸã—ã¦ãŠã‚Šã€å®Ÿéš›ã®TESTNETé‹ç”¨ã«ãŠã„ã¦ã‚‚ä¿¡é ¼æ€§ã®é«˜ã„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ãŒæœŸå¾…ã§ãã¾ã™ã€‚

GLIBCäº’æ›æ€§å•é¡ŒãŒè§£æ±ºã•ã‚Œã‚Œã°ã€å®Ÿéš›ã®ãƒãƒ«ãƒãƒãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã§ã®å‹•ä½œç¢ºèªãŒå¯èƒ½ã¨ãªã‚Šã€ã‚ˆã‚Šè©³ç´°ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ¤œè¨¼ãŒå®Ÿæ–½ã§ãã¾ã™ã€‚